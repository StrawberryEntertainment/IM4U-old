# IM4U Plugin

Import MMD Model and Motion file for UnrealEngine4 Plugin

create by BlackMa9(bm9)

This software is released under the MIT License, see LICENSE.txt.


# Get Start

1. GitHubからIM4Uのプラグインソースを丸ごと取得
2. 取得したソースから導入したいUEのプロジェクト(C++)の「Plugins」フォルダに本プラグイン「IM4U」フォルダ毎コピーする
3. プロジェクトを起動し、プラグインのビルドを実行させる
4. ビルドが完了しエディタが起動した際に、プラグインでIM4Uがインポートされていることを確認
5. ContentsBrowser内にMMD系ファイル(pmx,pmd,vmd)をインポートし各表示にしたがってAssetを生成する


# 制限事項

UE4にMMDで作成したモデルやVMDファイルをそのままDrag&Dropでインポートすることが出来ます。

本プラグインに関しては個人の趣味で作成したものであり、バグが含まれている可能性が十分あります。
本プラグインを使用したことにより、如何なる損害が発生しても著作権保有者は保証義務を一切負わないものとします。
PJ内のアセットを破壊やエディタの強制終了が発生してしまう場合がある為、事前及び定期的にバックアップをとっておくことを推奨します。
今後、プラグインのVersionUPにより専用アセットのデータ構造を変更する場合があります。
互換性を保証することは出来ない為、本プラグイン更新の前にPJのバックアップをとっておくことを推奨します。

また、MMDとの完全互換性は難しい為、本プラグインを使用しリソースを取り込んでも再現出来ない場合があります。
どうしてもそのリソースが必要である場合、他の手段で回避するor諦めて下さい。
MMDに関しても理解不足の箇所もあり誤った実装をしている可能性もあります。
本プラグインで作成するアセットはReImport処理未対応の為、一度ファイルを削除した上で再度Drag&Dropでインポートする必要があります。
また、一部の文字がファイル名、ボーン名、Morph名などに入っている場合、UE4の都合によりツール内で別の文字に置換している場合があります。

なお、UE4.7.xでのみ動作確認をしています。
現時点で対応しているインポート処理は下記の各制限事項に記載通りとなります。


## 制限：MMDモデルのインポート

・PMX,PMDファイルをDrag&DropすることでSkeletonMeshのAssetを作成します。
　StaticMeshでのインポート処理は未対応です。
　(ただし、拡張子をpmd_st,pmx_stとすることで、試作機能としてインポートすることも可能ですがライティングでビルドNGになります)
・PMD形式でインポートした際には内部でPMX形式に変換し処理していますが、
　一部処理未対応によりデータ落ちしている場合があります。
・PMXは2.1形式でも読み込み可能であるが、制限事項に記載の通り一部取り込んでいないデータがあります。
・アセット名はPMD,PMX内のモデル名称(JP)から読み取り生成しています。(ファイル名は現在参照していません。必要であれば今後対応予定)
・PhAT(物理アセット)による剛体およびJointの再現は未対応(FBX読み込み時と同じ最低限の処理のみ実施)。
・ボーンに関しては先頭に「ルート」という名称で親ボーンを追加し、UE4内にインポートしています。
・ボーンの座標軸が手抜きのため、すべて同じ座標系となります。(ローカル軸未対応)
・ボーンのウェイトはBDEF1のみ対応しています。
・ボーンのIK設定は未対応(通常ボーンとしてインポートしています)
・Morphを読み込みたい場合は、ImportOptionでMorph欄にチェックを入れる必要があります(FbxImport時と同じ)
・MMDの表情データに関しては頂点モーフのみ対応しています。
・インポート時のマテリアル生成に関しては別途マテリアルの制限事項を参照。
・インポート後法線マップの修正処理が無いため、モデルによっては法線マップがおかしい場合があります。
　回避方法として、PMD/PMXエディタにて「不正法線の修正」を実施した上でインポートすることで法線マップをある程度再現できます。

他。

## 制限：マテリアル

・PMD,PMXのモデルインポート時にデータ内に設定されている材質及びテクスチャ情報を元に自動生成しています。
・マテリアルに関しては、知識不足によりお試しで実装しています。(間違ったマテリアル設定をしいます)
・彩度の低い色では透過されてしまう場合があり必要に応じて修正が必要となります。(Opacityにリンク接続しているため)
・AutoLuminousは未対応となります。(ソース上ではEmissiveとして発光処理をテストで実装していますが、コメントアウト中)
・スフィアマップは未対応。
・エッジは未対応。必要に応じてLevel内にPostProcessにて追加で実装すること。
・テクスチャのアセット命名規則は、"T_"+ファイル名(拡張子を除く) となります。
　拡張子以外のファイル名が同じ場合正しくアセットを生成出来ない場合があります。
　ファイル名に期待しない文字が挿入されている場合、正しくアセットを生成出来ない場合があります。
　現時点では、必要に応じてファイル名とMMDモデル内のファイル参照情報を修正しておく必要があります。
・マテリアルのアセット命名規則は、"MT_"+材質名 となります。

他。

## 制限：VMDモーションのインポート

・VMDファイルをDrag&DropすることでAnimSequenceアセットを生成することができます。
　この時ImportOption(Slate)にて対象のSkeletonMeshのアセットを選択する必要があります。
　対象のSkeletonに該当ボーン及びモーフ名が存在しない場合はそのTrack(名称)のみ破棄されます。
　回避策として、DataTable(MMD2UE4NameTableRow)を追加指定することで名称の読み替えを実施できます。
・ただし、VMDインポート処理の仮実装をしていますが、
　Ik処理が未実装及び未実装によりのIKに依存するモーションでは期待しないポーズとなるため、正式にはまだVMDは未対応とります。
　インポート先のSkeletonの各ボーンの座標系によっては意図しないモーションになる場合があります。
　同様に物理演算の挙動を再現出来ないため、例えばMMMなどのツールで事前にVMD内に物理挙動を焼き込んでおくことで擬似再現が可能。
・VMD内のKey及び補間曲線のデータからAnimSequenceのアセットを生成する際に、30FPSで各ボーンの位置を計算しKeyを打ち直しています。
・VMD内の表情(モーフ)に関してはほぼ実装が完了しています。
　既存のAnimSequenceに対し後付でMorphCurveを追加することができます。
　モーフのみ後付でインポートしたい場合は、対象SkeletonMesh(必須)、追加AnimSequence(必須)、
　DataTable(後述の名称対応表)(任意) を指定する必要があります。
　この時、追加AnimSequenceに指定したアセットに直接MorphCurveを追加します。(事前に元アセット複製しておくことを推奨)
・後付モーフの場合、追加先のAnimSequenceアセットのフレーム数以上のVMDデータを追加インポートする場合、
　超えたフレームのデータは破棄されます。
・VMDインポート時に対象のSkeletonMesh内とVMD(MMD)側のボーン名及びモーフ名が異なる場合、
　事前にcsv形式で対応表となるDateTable(MMD2UE4NameTableRow)アセットを作成しておく必要があります。
　上記DataTableをVMDImportOputionに追加指定しておくことで、MMD->UE4向けに名称変換し該当する名称が存在する場合、
　読み替えた上で該当Track(名称)のアニメーションをインポートできます。
・上記、FMMD2UE4NameTableRowのデータテーブル形式は「Name="UE4側の名称",MmdOrignalName="MMD側の名称"」でUTF-8となります。
　ここでいう名称とは、ボーン名とモーフターゲット名を示しています。
　例(csv)：bone1,新規ボーン1
・上記変換テーブルを作成しておくことで、例えばUnity側のツールMMD4Mecanimなどで作成した
　Fbxアニメーションから作成したAnimSequenceアセットに対し、
　UE4用のMorphCurveとしてモーフのみ後付で追加することが可能です。
・VMDデータからAnimSequenceアセットを新規作成する場合の命名規則は、
　”VMDのファイル名(拡張子を除く)”+"_"+"SkeletonMeshのアセット名" となります。

他。

## FMMD2UE4NameTableRow(MMD-UE4間の名称変換表)について

csvにUTF-8形式(SJISの場合、文字化けが発生します)で記載し、Drag&Dropすることで
DataTable(FMMD2UE4NameTableRow指定)を作成できます。
このテーブルを使うことでVMD読み込み時に内部で名称を読み替えてインポートすることができます。
一行目に「Name,MmdOrignalName」を必ず記載し、2行目から各名称の対応関係を記述する必要があります。

ファイルの記述例：hogehoge.csv

> Name,MmdOrignalName
122_!Root,ルート
1_joint_Torso,上半身
79_!joint_RightToe,右つま先
70_joint_RightFoot,右足首
69_joint_RightKnee,右ひざ
68_joint_RightHip,右足
0_?????????,真面目
1_??????,困る
2_?????????,にこり


# ToDo

・ MMDモデルの互換性及び読み込み時のデータ落ち修正
・ IKボーンの対応
・ 特殊ボーンのWeightの対応
・ MMDモデルの剛体からPhATアセットの作成処理
・ VMDインポート処理(IKおよび物理挙動、ボーンのアニメーション)
・ 各Assetインポート時のGui(Slate)の作成(大半の項目はダミーの為)
・ マテリアルの対応(透過処理など)
・ 各AssetのRe-Import対応
~~・ VMDインポート時にターゲット(Skeleton)のボーン/Morph名とVMD内のボーン/Skin名との対応付機能。(外部FBX変換ツールとの互換用)~~

などなど

# Release Note

## ver 0.6.0 15/04/01

・1st alpha ver. release
・UE 4.7.x系でのみ対応開始

## ver 0.6.1 15/04/05

・バグ修正

## ver 0.6.5 15/04/26

・VMDインポート機能の試験実装(IKおよび物理挙動は未対応)
・VMDインポート機能追加により既存AnimSequenceアセットに後付でモーフのみ追加することが可能
・各データインポート時に簡単な制限事項のSlate表示を追加
・SkeletonMesh作成時の親Boneの名称を「ルート」名に変更
・他、バグ修正

以上
